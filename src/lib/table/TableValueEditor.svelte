<script lang="ts">
    import MultilinesInput from "$lib/widgets/MultilinesInput.svelte";
    import Select from "$lib/widgets/Select.svelte";
    import JsonValueEditor from "./valueEditors/JsonValueEditor.svelte";
    import type {PgColumn, PgRow} from "./pgContext.svelte";
    import {valueToSql} from "./values";
    import TextValueEditor from "./valueEditors/TextValueEditor.svelte";

    type Props = {
        inlined: boolean;
        column: PgColumn;
        row: PgRow;
    };
    let {column, row = $bindable(), inlined}: Props = $props();

    const disabled = $derived.by(() => {
        return column.is_primary_key === "YES";
    });

    const placeholder = $derived.by(() => {
        if (column.is_primary_key === "YES" && !row[column.column_name]) {
            return "Generated by default";
        } else if (
            (column.is_nullable === "YES" && row[column.column_name] === null) ||
            row[column.column_name] === undefined
        ) {
            return "null";
        }
        return "Enter a value";
    });
</script>

{#if column.is_nullable === "YES" && row[column.column_name] === null}
    <input
        id={column.column_name}
        type="text"
        class="font-mono!"
        autocorrect="off"
        autocomplete="off"
        autocapitalize="off"
        disabled={true}
        placeholder="null"
    />
{:else if column.is_primary_key === "YES" && row[column.column_name] === null}
    <input
        id={column.column_name}
        type="text"
        class="font-mono!"
        autocorrect="off"
        autocomplete="off"
        autocapitalize="off"
        disabled={true}
        placeholder="generated"
    />
{:else if column.enum_values}
    <Select
        class="font-mono font-normal! w-full"
        id={column.column_name}
        {disabled}
        bind:value={row[column.column_name]}
    >
        {#each column.enum_values as enumValue}
            <option>{enumValue}</option>
        {/each}
    </Select>
{:else if column.data_type === "boolean" || column.data_type === "bool"}
    <Select
        class="font-mono font-normal!"
        id={column.column_name}
        {disabled}
        bind:value={() => valueToSql(column, row[column.column_name]), (value) => (row[column.column_name] = value)}
    >
        <option>true</option>
        <option>false</option>
    </Select>
{:else if column.data_type === "tsvector"}
    <input
        id={column.column_name}
        type="text"
        class="font-mono!"
        autocorrect="off"
        autocomplete="off"
        autocapitalize="off"
        disabled={true}
        placeholder="generated"
    />
{:else if column.data_type === "text" || column.data_type === "xml"}
    <TextValueEditor bind:value={row[column.column_name] as string} {column} {inlined} />
{:else if ["json", "jsonb"].includes(column.data_type)}
    <JsonValueEditor
        bind:value={
            () => {
                console.log("value = ", row[column.column_name]);
                return JSON.stringify(row[column.column_name], null, 4);
            },
            (newValue) => {
                console.log("setValue", newValue);
                row[column.column_name] = JSON.parse(newValue);
            }
        }
        {column}
        {inlined}
    />
{:else}
    <input
        id={column.column_name}
        type="text"
        class="font-mono!"
        autocorrect="off"
        autocomplete="off"
        autocapitalize="off"
        {disabled}
        {placeholder}
        bind:value={row[column.column_name] as string}
    />
{/if}
